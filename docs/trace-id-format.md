# Trace ID Format and Usage Guide

This document describes the trace ID format, implementation details, and how to use trace IDs for debugging in the Simple Media Manager (SMM) application.

## Overview

Trace IDs are unique identifiers that correlate logs across the entire request lifecycle: from user action in the UI → HTTP API layer → backend business logic → file system operations. This enables end-to-end request tracing for better observability and faster issue diagnosis.

## Trace ID Format

### Format Specification

```
{event_name}-{counter}
```

- **event_name**: Identifies the source component or function (e.g., `AiSettings`, `GeneralSettings`, `MediaFolderListItem`)
- **counter**: Integer counter generated by `nextTraceId()` utility, persisted in localStorage

### Examples

| Source Component | Trace ID Example | Context |
|----------------|-------------------|----------|
| AI Settings | `AiSettings-1241` | Saving AI configuration |
| General Settings | `GeneralSettings-1322` | Saving general application settings |
| Media Folder List Item | `MediaFolderListItem-1456` | Deleting or renaming a media folder |
| AppV2 (Main) | `AppV2-updateMediaMetadata-1567` | Updating media metadata |
| TV Show Panel | `TvShowPanel-executeRenamePlan-1689` | Executing file rename plan |
| Match Episode Tool | `MatchEpisode-execute-1890` | Matching episodes using AI |

## Implementation Details

### UI Layer

#### Generating Trace IDs

Trace IDs are generated at the point where an action originates:

```typescript
import { nextTraceId } from '@/lib/utils'

// In component or event handler
const traceId = `AiSettings-${nextTraceId()}`;  // e.g., "AiSettings-1241"

console.log(`[${traceId}] AiSettings: Saving AI settings`);

// Pass trace ID through the call chain
await writeFile(filePath, content, parseInt(traceId.split('-')[1], 10));
```

#### Logging Format

UI console logs use `[traceId]` prefix format:

```typescript
console.log(`[${traceId}] saveUserConfig: Starting save operation`);
console.log(`[${traceId}] saveUserConfig: Writing config to ${filePath}`);
console.log(`[${traceId}] saveUserConfig: User config written successfully`);
```

Output in browser console:
```
[AiSettings-1241] saveUserConfig: Starting save operation
[AiSettings-1241] saveUserConfig: Writing config to C:\Users\...\smm.json
[AiSettings-1241] saveUserConfig: User config written successfully
```

#### HTTP Header Transport

The numeric counter is extracted and sent via `X-Trace-Id` HTTP header:

```typescript
// Extract numeric counter from full trace ID
const numericTraceId = parseInt(traceId.split('-')[1], 10);  // 1241 from "AiSettings-1241"

// Add to HTTP headers
headers['X-Trace-Id'] = numericTraceId.toString();  // "1241"
```

**Note**: Only the numeric counter (not the full trace ID string) is sent in the HTTP header. The event name is redundant in the backend context.

### API Layer

#### writeFile API Function

```typescript
async function writeFile(path: string, content: string, traceId?: number) {
  if (traceId) {
    console.log(`[${traceId}] writeFile: Writing to ${path}`);
  }

  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
  };

  if (traceId) {
    headers['X-Trace-Id'] = traceId.toString();  // Numeric counter as string
  }

  const resp = await fetch('/api/writeFile', {
    method: 'POST',
    headers,
    body: JSON.stringify({ path, data: content, mode: 'overwrite' }),
  });

  if (traceId) {
    console.log(`[${traceId}] writeFile: Response received`, await resp.json());
  }
}
```

### Backend Layer

#### Extracting Trace ID from HTTP Header

```typescript
export function handleWriteFile(app: Hono) {
  app.post('/api/writeFile', async (c) => {
    // Extract numeric counter from header
    const traceId = parseInt(c.req.header('X-Trace-Id') || '0', 10);

    // Pass to business logic
    const result = await doWriteFile(body, traceId);

    return c.json(result, 200);
  });
}
```

#### Pino Structured Logging

Backend logs use pino structured logging with `traceId` as a numeric field:

```typescript
import { logger } from '../../lib/logger';

async function doWriteFile(body: WriteFileRequestBody, traceId: number = 0) {
  // Log with trace ID in structured data
  logger.info({ traceId }, 'doWriteFile: Starting file write operation');

  logger.debug({ traceId, filePath, mode, dataSize: data.length }, 
    'doWriteFile: Processing write request');

  logger.info({ traceId, path, size: data.length }, 
    'doWriteFile: File written successfully');
}
```

Output in backend log file (smm.log):
```json
{"level":30,"time":1769528589175,"pid":28740,"hostname":"GameStation","traceId":1241,"msg":"doWriteFile: Starting file write operation"}
{"level":20,"time":1769528589176,"pid":28740,"hostname":"GameStation","traceId":1241,"filePath":"C:\\Users\\lawrence\\AppData\\Roaming\\SMM\\smm.json","mode":"overwrite","dataSize":1234,"msg":"doWriteFile: Processing write request"}
{"level":30,"time":1769528589180,"pid":28740,"hostname":"GameStation","traceId":1241,"path":"C:\\Users\\lawrence\\AppData\\Roaming\\SMM\\smm.json","size":1234,"msg":"doWriteFile: File written successfully"}
```

## nextTraceId() Utility

The `nextTraceId()` function generates unique counters and persists them in localStorage:

```typescript
// Location: ui/src/lib/utils.ts
const STORAGE_KEY_TRACE_ID = 'traceId';
let runtimeTraceIdCounter = 0;

export function nextTraceId(): number {
  try {
    const stored = localStorage.getItem(STORAGE_KEY_TRACE_ID);
    const currentId = stored !== null ? parseInt(stored, 10) : 0;
    const nextId = isNaN(currentId) ? 1 : currentId + 1;
    localStorage.setItem(STORAGE_KEY_TRACE_ID, nextId.toString());
    return nextId;
  } catch (error) {
    // Fallback to runtime counter if localStorage fails
    runtimeTraceIdCounter++;
    return runtimeTraceIdCounter;
  }
}
```

### Features

- **LocalStorage Persistence**: Counter persists across page reloads
- **Runtime Fallback**: Works in private browsing mode or when storage quota exceeded
- **Uniqueness**: Guarantees unique IDs within a session
- **Incrementing**: Counter always increases (never resets or decreases)

## Using Trace IDs for Debugging

### Browser Console (UI Layer)

#### Filtering by Trace ID

Use DevTools Console filter to show only logs for a specific trace ID:

```
AiSettings-1241
```

This filters console to show only messages containing `AiSettings-1241`.

#### Searching Console Logs

1. Open DevTools Console
2. Press `Ctrl+Shift+F` (or `Cmd+Shift+F` on Mac)
3. Enter trace ID (e.g., `AiSettings-1241`)
4. Review all matching log entries

### Backend Logs (Pino Format)

Backend logs are in JSON format located at:
- **Windows**: `C:\Users\lawrence\AppData\Local\SMM\logs\smm.log`
- **Linux/Mac**: `~/.local/SMM/logs/smm.log`

#### Filtering with grep

```bash
# Filter by trace ID counter
grep '"traceId":1241' C:/Users/lawrence/AppData/Local/SMM/logs/smm.log

# Show only error logs with trace ID
grep '"traceId":1241' C:/Users/lawrence/AppData/Local/SMM/logs/smm.log | grep '"level":50'

# Show log entries from a specific time range
grep '"traceId":1241' C:/Users/lawrence/AppData/Local/SMM/logs/smm.log | grep '"time":17695285891'
```

#### Filtering with jq (Advanced)

```bash
# Pretty-print and filter by trace ID
cat smm.log | jq 'select(.traceId == 1241)'

# Extract specific fields
cat smm.log | jq 'select(.traceId == 1241) | {msg, level, time}'
```

#### Example Debugging Workflow

1. **Identify the issue** (e.g., "Config save failed")

2. **Find the trace ID in UI console**:
   - Open DevTools Console
   - Search for error messages
   - Note the trace ID from context (e.g., `AiSettings-1284`)

3. **Trace through API layer**:
   - Open DevTools Network tab
   - Find the `/api/writeFile` request
   - Check request headers contain `X-Trace-Id: 1284`
   - Verify request body doesn't contain `traceId` field

4. **Trace through backend layer**:
   - Open backend log file
   - Filter by `grep '"traceId":1284'`
   - Review complete flow from request to file write

5. **Correlate logs across layers**:
   - UI: `[AiSettings-1284] saveUserConfig: Starting`
   - API: `X-Trace-Id: 1284` header
   - Backend: `{"traceId":1281, "msg":"doWriteFile: Starting"}`

## Best Practices

### Naming event_name

- **Use component names** for UI actions: `AiSettings`, `GeneralSettings`, `TvShowPanel`
- **Use function names** for internal operations: `saveUserConfig`, `refreshMediaMetadata`
- **Add context suffix** when helpful: `AiSettings-saveConfig`, `TvShowPanel-executeRenamePlan`

### Logging Guidelines

- **Always include trace ID**: Every log message in the trace chain should include the trace ID
- **Use consistent format**: `[traceId]` prefix for UI, `traceId` field for pino
- **Log at boundaries**: Add trace ID at entry points and exit points of operations
- **Include context**: Add relevant data to logs (file paths, operation types, results)

### When to Generate Trace IDs

Generate a trace ID when:
- User initiates an action (button click, form submission)
- Starting a new operation flow (rename, recognize, save)
- Making API calls that involve business logic
- Executing long-running operations

**Don't generate** for:
- Simple UI state changes that don't persist
- Internal component re-renders
- Trivial operations that don't cross system boundaries

## Troubleshooting

### Issue: Trace ID missing from logs

**Symptoms**:
- Logs don't show trace ID prefixes
- `traceId` field is 0 in all backend logs

**Possible Causes**:
1. **Trace ID not generated**: Check if `nextTraceId()` is called at operation entry point
2. **Trace ID not propagated**: Verify trace ID is passed through function parameters
3. **Header not added**: Check `X-Trace-Id` header is set in API calls

**Debug Steps**:
```typescript
// Add temporary logging to verify trace ID generation
const traceId = `AiSettings-${nextTraceId()}`;
console.log('[DEBUG] Generated trace ID:', traceId);  // Should see in console

// Verify propagation
async function saveUserConfig(traceId: string, config: UserConfig) {
  console.log('[DEBUG] Received trace ID:', traceId);  // Should see in console
  // ... rest of function
}
```

### Issue: Trace ID doesn't match across layers

**Symptoms**:
- UI console shows `AiSettings-1290`
- Backend logs show `{"traceId":1289, ...}`

**Possible Causes**:
1. **Race condition**: Multiple requests in-flight, different trace IDs
2. **Caching**: Old request logs from previous operation
3. **Numeric extraction error**: `parseInt(traceId.split('-')[1], 10)` failing

**Debug Steps**:
1. Check if multiple save operations triggered simultaneously
2. Verify only one trace ID active per user action
3. Add console log to verify extraction: `console.log('[DEBUG] Numeric trace ID:', parseInt(traceId.split('-')[1], 10))`

### Issue: LocalStorage not persisting

**Symptoms**:
- Trace ID counter resets to 1 after page refresh
- Same trace IDs appear repeatedly

**Possible Causes**:
1. **Private browsing mode**: LocalStorage disabled
2. **Storage quota exceeded**: LocalStorage full
3. **Different browser context**: Incognito or multiple tabs

**Verification**:
```javascript
// Check in browser console
console.log('LocalStorage traceId:', localStorage.getItem('traceId'));
console.log('LocalStorage available:', typeof Storage !== 'undefined');
```

**Fallback**: The `nextTraceId()` function automatically falls back to runtime counter if localStorage fails.

## API Documentation

### POST /api/writeFile

Write file content to a specified path.

**Request Headers**:
- `Content-Type: application/json`
- `X-Trace-Id: <numeric_counter>` (optional, string representation of number)

**Example**:
```
Content-Type: application/json
X-Trace-Id: 1241
```

**Request Body**:
```json
{
  "path": "C:\\Users\\lawrence\\AppData\\Roaming\\SMM\\smm.json",
  "data": "{\"applicationLanguage\":\"zh-CN\",...}",
  "mode": "overwrite"
}
```

**Response**:
- HTTP Status: 200 (success) or 400 (error)
- Body:
```json
{
  "data": {},  // Success (empty object)
  "error": "Error Reason: detail message"  // Error (if any)
}
```

**Notes**:
- `X-Trace-Id` is optional - missing header defaults to `0` for logging
- Request body is unchanged - no `traceId` field added
- Backward compatible with old clients that don't send the header

## References

- **Trace ID Overview**: `docs/trace-id.md`
- **OpenSpec Change**: `openspec/changes/add-trace-id-for-save-user-config/`
- **Implementation**:
  - UI: `ui/src/providers/config-provider.tsx`
  - API: `ui/src/api/writeFile.ts`
  - Backend: `cli/src/route/WriteFile.ts`
  - Logger: `cli/lib/logger.ts`
